#!/bin/bash
# Multi-Profile VPN - Delete Profile
# Backend script untuk delete profile dan cleanup

# Load config
if [ -f /etc/vpn-system.conf ]; then
    source /etc/vpn-system.conf
fi

VPN_HOME="${VPN_HOME:-/opt/multi-profile-vpn}"
DB_PATH="${DB_PATH:-$VPN_HOME/data/app.db}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

PROFILE_NAME="$1"

if [ -z "$PROFILE_NAME" ]; then
    echo -e "${RED}Error: Profile name is required${NC}"
    echo "Usage: $0 <profile-name>"
    exit 1
fi

# Check if profile exists
PROFILE_EXISTS=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM profiles WHERE name='$PROFILE_NAME';" 2>/dev/null)

if [ "$PROFILE_EXISTS" -eq 0 ]; then
    echo -e "${RED}Error: Profile '$PROFILE_NAME' not found${NC}"
    exit 1
fi

echo -e "${YELLOW}Deleting profile: $PROFILE_NAME${NC}"
echo ""

# Confirm
echo -ne "${RED}Are you sure? This action cannot be undone! [y/N]: ${NC}"
read CONFIRM

if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
    echo -e "${CYAN}Cancelled${NC}"
    exit 0
fi

echo ""

# Stop and remove Docker container
echo -e "${BLUE}[1/3]${NC} Stopping Docker container..."
docker stop "vpn-$PROFILE_NAME" > /dev/null 2>&1
docker rm "vpn-$PROFILE_NAME" > /dev/null 2>&1
echo -e "${GREEN}✓${NC} Container removed"

# Remove from database
echo -e "${BLUE}[2/3]${NC} Removing from database..."
sqlite3 "$DB_PATH" "DELETE FROM profiles WHERE name='$PROFILE_NAME';" 2>/dev/null
sqlite3 "$DB_PATH" "DELETE FROM profile_accounts WHERE profile_id IN (SELECT profile_id FROM profiles WHERE name='$PROFILE_NAME');" 2>/dev/null
sqlite3 "$DB_PATH" "DELETE FROM bandwidth_logs WHERE profile_id IN (SELECT profile_id FROM profiles WHERE name='$PROFILE_NAME');" 2>/dev/null
echo -e "${GREEN}✓${NC} Database cleaned"

# Cleanup
echo -e "${BLUE}[3/3]${NC} Cleaning up..."
rm -rf "/etc/vpn-profiles/$PROFILE_NAME" 2>/dev/null
echo -e "${GREEN}✓${NC} Cleanup complete"

echo ""
echo -e "${GREEN}Profile '$PROFILE_NAME' deleted successfully!${NC}"
echo ""
