#!/bin/bash
# Multi-Profile VPN - Backup Daemon
# Simple backup for database

# Load config
if [ -f /etc/vpn-system.conf ]; then
    source /etc/vpn-system.conf
fi

VPN_HOME="${VPN_HOME:-/opt/multi-profile-vpn}"
DB_PATH="${DB_PATH:-$VPN_HOME/data/app.db}"
BACKUP_DIR="${BACKUP_DIR:-$VPN_HOME/backups}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

ACTION="${1:-backup}"

case $ACTION in
    backup)
        echo -e "${CYAN}Creating backup...${NC}"
        
        # Create backup directory
        mkdir -p "$BACKUP_DIR"
        
        # Generate backup filename with timestamp
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BACKUP_FILE="$BACKUP_DIR/vpn-backup-$TIMESTAMP.db"
        
        # Copy database
        cp "$DB_PATH" "$BACKUP_FILE"
        
        if [ $? -eq 0 ]; then
            # Compress backup
            gzip "$BACKUP_FILE"
            echo -e "${GREEN}✓ Backup created: ${BACKUP_FILE}.gz${NC}"
            
            # Keep only last 10 backups
            cd "$BACKUP_DIR"
            ls -t vpn-backup-*.db.gz 2>/dev/null | tail -n +11 | xargs rm -f 2>/dev/null
        else
            echo -e "${RED}Error: Backup failed${NC}"
            exit 1
        fi
        ;;
        
    list)
        echo -e "${CYAN}Available backups:${NC}"
        echo ""
        ls -lh "$BACKUP_DIR"/vpn-backup-*.db.gz 2>/dev/null | awk '{print $9, "(" $5 ")"}'
        ;;
        
    restore)
        BACKUP_FILE="$2"
        
        if [ -z "$BACKUP_FILE" ]; then
            echo -e "${RED}Error: Backup file not specified${NC}"
            echo "Usage: $0 restore <backup-file>"
            exit 1
        fi
        
        if [ ! -f "$BACKUP_FILE" ]; then
            echo -e "${RED}Error: Backup file not found${NC}"
            exit 1
        fi
        
        echo -e "${CYAN}Restoring from backup...${NC}"
        
        # Backup current database
        cp "$DB_PATH" "$DB_PATH.before-restore"
        
        # Restore
        if [[ "$BACKUP_FILE" == *.gz ]]; then
            gunzip -c "$BACKUP_FILE" > "$DB_PATH"
        else
            cp "$BACKUP_FILE" "$DB_PATH"
        fi
        
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}✓ Database restored from backup${NC}"
            echo -e "  Previous database saved as: $DB_PATH.before-restore"
        else
            echo -e "${RED}Error: Restore failed${NC}"
            exit 1
        fi
        ;;
        
    *)
        echo "Usage: $0 {backup|list|restore <file>}"
        exit 1
        ;;
esac
