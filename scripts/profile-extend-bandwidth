#!/bin/bash
# Multi-Profile VPN - Extend Profile Bandwidth
# Add more bandwidth quota to profile

# Load config
if [ -f /etc/vpn-system.conf ]; then
    source /etc/vpn-system.conf
fi

VPN_HOME="${VPN_HOME:-/opt/multi-profile-vpn}"
DB_PATH="${DB_PATH:-$VPN_HOME/data/app.db}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

PROFILE_NAME="$1"
ADD_TB="$2"

if [ -z "$PROFILE_NAME" ] || [ -z "$ADD_TB" ]; then
    echo -e "${RED}Error: Missing parameters${NC}"
    echo "Usage: $0 <profile-name> <TB-to-add>"
    exit 1
fi

# Check if profile exists
PROFILE_EXISTS=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM profiles WHERE name='$PROFILE_NAME';" 2>/dev/null)

if [ "$PROFILE_EXISTS" -eq 0 ]; then
    echo -e "${RED}Error: Profile '$PROFILE_NAME' not found${NC}"
    exit 1
fi

# Convert TB to GB
ADD_GB=$(echo "$ADD_TB * 1024" | bc)

# Get current bandwidth quota
CURRENT_QUOTA=$(sqlite3 "$DB_PATH" "SELECT bandwidth_quota_gb FROM profiles WHERE name='$PROFILE_NAME';" 2>/dev/null)
CURRENT_USED=$(sqlite3 "$DB_PATH" "SELECT quota_used_gb FROM profiles WHERE name='$PROFILE_NAME';" 2>/dev/null)

# Calculate new quota
NEW_QUOTA=$(echo "$CURRENT_QUOTA + $ADD_GB" | bc)
NEW_QUOTA_TB=$(echo "scale=2; $NEW_QUOTA / 1024" | bc)

# Update database
sqlite3 "$DB_PATH" "UPDATE profiles SET bandwidth_quota_gb=$NEW_QUOTA, quota_tb=$(echo "scale=2; $NEW_QUOTA / 1024" | bc), updated_at=datetime('now') WHERE name='$PROFILE_NAME';" 2>/dev/null

if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ“ Extended bandwidth for '$PROFILE_NAME'${NC}"
    echo -e "  New quota: ${CYAN}${NEW_QUOTA_TB}TB${NC} (${NEW_QUOTA}GB)"
    
    # Show usage
    USED_TB=$(echo "scale=2; $CURRENT_USED / 1024" | bc)
    PERCENT=$(echo "scale=1; ($CURRENT_USED / $NEW_QUOTA) * 100" | bc)
    
    echo -e "  Current usage: ${CYAN}${USED_TB}TB${NC} / ${CYAN}${NEW_QUOTA_TB}TB${NC} (${PERCENT}%)"
else
    echo -e "${RED}Error: Failed to update bandwidth quota${NC}"
    exit 1
fi
